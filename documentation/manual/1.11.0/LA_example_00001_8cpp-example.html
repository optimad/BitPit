---
layout: doxygen_header
title: Manual - LA_example_00001.cpp
section: documentation
doxygen-show-titlearea: 0
extra-head-includes:
    - doxygen_extra_head.html
---
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
{% if page.doxygen-show-titlearea == 1 %}
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">bitpit
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
{% endif %}
<!-- end header part -->
{% raw %}
<!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div class="header">
  <div class="headertitle"><div class="title">LA_example_00001.cpp</div></div>
</div><!--header-->
<div class="contents">
<p>This example shows how to dump and restore a SystemSolver.</p>
<p>This example shows how to dump and restore a SystemSolver.This example builds a small linear system, it dumps it to the disk, it solves the linear system and it exports the solution to disk. Dump files will be saved in the current directory and they names are: LA_example_0001_linear_system_A.dat LA_example_0001_linear_system_A.dat.info LA_example_0001_linear_system_A.info.dat LA_example_0001_linear_system_A.partitioning.bXXXX.dat LA_example_0001_linear_system_info.dat LA_example_0001_linear_system_rhs.dat LA_example_0001_linear_system_rhs.dat.info LA_example_0001_linear_system_rhs.info.dat LA_example_0001_linear_system_rhs.partitioning.bXXXX.dat LA_example_0001_linear_system_solution.dat LA_example_0001_linear_system_solution.dat.info LA_example_0001_linear_system_solution.info.dat LA_example_0001_linear_system_solution.partitioning.bXXXX.dat</p>
<p>This example contains an extension of the bare SystemSolver class adding the ability to solve using algebraic multigrid (PETSc GAMG) preconditioner. Only non-block matrices can be solved using GAMG. A check disables algebraic multigrid for block matrices with a message in the logger.</p>
<p><b>To run</b>: ./LA_example_00001.cpp <br  />
 </p><div class="fragment"><div class="line"><span class="comment">/*---------------------------------------------------------------------------*\</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *  bitpit</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *  Copyright (C) 2015-2023 OPTIMAD engineering Srl</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *  -------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment"> *  License</span></div>
<div class="line"><span class="comment"> *  This file is part of bitpit.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *  bitpit is free software: you can redistribute it and/or modify it</span></div>
<div class="line"><span class="comment"> *  under the terms of the GNU Lesser General Public License v3 (LGPL)</span></div>
<div class="line"><span class="comment"> *  as published by the Free Software Foundation.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *  bitpit is distributed in the hope that it will be useful, but WITHOUT</span></div>
<div class="line"><span class="comment"> *  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span></div>
<div class="line"><span class="comment"> *  FITNESS FOR A PARTICULAR PURPOSE. See the GNU Lesser General Public</span></div>
<div class="line"><span class="comment"> *  License for more details.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> *  You should have received a copy of the GNU Lesser General Public License</span></div>
<div class="line"><span class="comment"> *  along with bitpit. If not, see &lt;http://www.gnu.org/licenses/&gt;.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment">\*---------------------------------------------------------------------------*/</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;array&gt;</span></div>
<div class="line"><span class="preprocessor">#if BITPIT_ENABLE_MPI==1</span></div>
<div class="line"><span class="preprocessor">#include &lt;mpi.h&gt;</span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &quot;bitpit_common.hpp&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;bitpit_LA.hpp&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">using namespace </span>bitpit;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span><a id="_a0" name="_a0"></a><a class="code hl_class" href="classAMGSystemSolver.html">AMGSystemSolver</a> : <span class="keyword">public</span> <a id="_a1" name="_a1"></a><a class="code hl_class" href="classbitpit_1_1SystemSolver.html">SystemSolver</a> {</div>
<div class="line"> </div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    <a id="a2" name="a2"></a><a class="code hl_function" href="classAMGSystemSolver.html#a5b9144e3e5eb76216e3ecbe73d0e2072">AMGSystemSolver</a>(<span class="keywordtype">bool</span> transpose, <span class="keywordtype">bool</span> multigrid, <span class="keywordtype">bool</span> debug)</div>
<div class="line">        : <a id="a3" name="a3"></a><a class="code hl_function" href="classbitpit_1_1SystemSolver.html#aca37164c4ecb430a9e36b5723186e95f">SystemSolver</a>(multigrid, transpose, debug),</div>
<div class="line">          m_multigrid(multigrid)</div>
<div class="line">    {</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line"><span class="keyword">protected</span>:</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">static</span> PetscInt GAMG_MAX_LEVELS;</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">static</span> PetscReal GAMG_THRESHOLD;</div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">static</span> PetscReal GAMG_THRESHOLD_SCALE;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">bool</span> m_multigrid;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">void</span> <a id="a4" name="a4"></a><a class="code hl_function" href="classbitpit_1_1SystemSolver.html#ae9c0399c50d31d23c0f49e75d5a95434">setupPreconditioner</a>(PC pc, <span class="keyword">const</span> <a id="_a5" name="_a5"></a><a class="code hl_struct" href="structbitpit_1_1KSPOptions.html">KSPOptions</a> &amp;options)<span class="keyword"> const override</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">        <span class="comment">// Early return for non-multigrid</span></div>
<div class="line">        <span class="keywordflow">if</span> (!m_multigrid) {</div>
<div class="line">            SystemSolver::setupPreconditioner(pc, options);</div>
<div class="line">            <span class="keywordflow">return</span>;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Set multigrid options</span></div>
<div class="line">        KSPGetPC(this-&gt;m_KSP, &amp;pc);</div>
<div class="line">        PCSetType(pc, PCGAMG);</div>
<div class="line"> </div>
<div class="line">        std::vector&lt;PetscReal&gt; thresholds(GAMG_MAX_LEVELS);</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; GAMG_MAX_LEVELS; ++i) {</div>
<div class="line">            thresholds[i] = GAMG_THRESHOLD;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        PCGAMGSetNSmooths(pc, 0);</div>
<div class="line"><span class="preprocessor">#if (PETSC_VERSION_MAJOR &gt;= 3 &amp;&amp; PETSC_VERSION_MINOR &lt;= 17)</span></div>
<div class="line"><span class="preprocessor">#if BITPIT_ENABLE_MPI == 1</span></div>
<div class="line">        <span class="keywordflow">if</span> (this-&gt;<a id="a6" name="a6"></a><a class="code hl_function" href="classbitpit_1_1SystemSolver.html#a0da428e8ea241f0d53ae8ee0e8ec19c3">isPartitioned</a>()) {</div>
<div class="line">            PCGAMGSetSymGraph(pc, PETSC_TRUE);</div>
<div class="line">        }</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"> </div>
<div class="line">        PCGAMGSetNlevels(pc, GAMG_MAX_LEVELS);</div>
<div class="line"><span class="preprocessor">#if (PETSC_VERSION_MAJOR &gt;= 3 &amp;&amp; PETSC_VERSION_MINOR &gt;= 16)</span></div>
<div class="line">        PCGAMGSetThreshold(pc, thresholds.data(), GAMG_MAX_LEVELS);</div>
<div class="line">        PCGAMGSetThresholdScale(pc, GAMG_THRESHOLD_SCALE);</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line">        PCGAMGSetThreshold(pc, GAMG_THRESHOLD);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Setup</span></div>
<div class="line">        PCSetUp(pc);</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Set options for the multigrid coarse level</span></div>
<div class="line">        KSP coarseKSP;</div>
<div class="line">        PCMGGetCoarseSolve(pc, &amp;coarseKSP);</div>
<div class="line"> </div>
<div class="line">        PC coarsePreconditioner;</div>
<div class="line">        KSPGetPC(coarseKSP, &amp;coarsePreconditioner);</div>
<div class="line">        PCSetType(coarsePreconditioner, PCSVD);</div>
<div class="line">    }</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">const</span> PetscInt AMGSystemSolver::GAMG_MAX_LEVELS       = 10;</div>
<div class="line"><span class="keyword">const</span> PetscReal AMGSystemSolver::GAMG_THRESHOLD       = 0.02;</div>
<div class="line"><span class="keyword">const</span> PetscReal AMGSystemSolver::GAMG_THRESHOLD_SCALE = 1.0;</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> run_dump(<span class="keywordtype">int</span> rank, <span class="keywordtype">int</span> nProcs)</div>
<div class="line">{</div>
<div class="line">    log::cout() &lt;&lt; std::endl;</div>
<div class="line">    log::cout() &lt;&lt; <span class="stringliteral">&quot;Running dump example...&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">int</span> nRows;</div>
<div class="line">    <span class="keywordtype">int</span> nCols;</div>
<div class="line">    <span class="keywordtype">int</span> nNZ;</div>
<div class="line">    <span class="keywordflow">if</span> (nProcs == 1) {</div>
<div class="line">        nRows = 10;</div>
<div class="line">        nCols = 10;</div>
<div class="line">        nNZ   = 10;</div>
<div class="line">    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (nProcs == 2) {</div>
<div class="line">        <span class="keywordflow">if</span> (rank == 0) {</div>
<div class="line">            nRows = 6;</div>
<div class="line">            nCols = 6;</div>
<div class="line">            nNZ   = 6;</div>
<div class="line">        } <span class="keywordflow">if</span> (rank == 1) {</div>
<div class="line">            nRows = 4;</div>
<div class="line">            nCols = 4;</div>
<div class="line">            nNZ   = 4;</div>
<div class="line">        }</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        <span class="keywordflow">if</span> (rank == 0) {</div>
<div class="line">            nRows = 2;</div>
<div class="line">            nCols = 2;</div>
<div class="line">            nNZ   = 2;</div>
<div class="line">        } <span class="keywordflow">if</span> (rank == 1) {</div>
<div class="line">            nRows = 5;</div>
<div class="line">            nCols = 5;</div>
<div class="line">            nNZ   = 5;</div>
<div class="line">        } <span class="keywordflow">if</span> (rank == 2) {</div>
<div class="line">            nRows = 3;</div>
<div class="line">            nCols = 3;</div>
<div class="line">            nNZ   = 3;</div>
<div class="line">        } <span class="keywordflow">else</span> {</div>
<div class="line">            nRows = 0;</div>
<div class="line">            nCols = 0;</div>
<div class="line">            nNZ   = 0;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">int</span> blockSize = 5;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Build matrix</span></div>
<div class="line">    log::cout() &lt;&lt; <span class="stringliteral">&quot;Building matrix...&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">    std::vector&lt;long&gt; rowPattern(1);</div>
<div class="line">    std::vector&lt;double&gt; rowValues(blockSize * blockSize);</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#if BITPIT_ENABLE_MPI==1</span></div>
<div class="line">    <a id="_a7" name="_a7"></a><a class="code hl_class" href="classbitpit_1_1SparseMatrix.html">SparseMatrix</a> matrix(MPI_COMM_WORLD, <span class="keyword">true</span>, blockSize, nRows, nCols, nNZ);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">int</span> rowOffset = matrix.getRowGlobalOffset();</div>
<div class="line">    <span class="keywordtype">int</span> colOffset = matrix.getColGlobalOffset();</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line">    <a class="code hl_class" href="classbitpit_1_1SparseMatrix.html">SparseMatrix</a> matrix(blockSize, nRows, nCols, nNZ);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">int</span> rowOffset = 0;</div>
<div class="line">    <span class="keywordtype">int</span> colOffset = 0;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; nRows; ++i) {</div>
<div class="line">        rowPattern[0] = colOffset + i;</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k = 0; k &lt; blockSize; ++k) {</div>
<div class="line">            <span class="keywordtype">int</span> kk = linearalgebra::linearIndexRowMajor(k, k, blockSize, blockSize);</div>
<div class="line"> </div>
<div class="line">            rowValues[kk]  = 1. / (double) (blockSize * (rowOffset + i) + k + 1);</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        matrix.addRow(rowPattern, rowValues);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    matrix.assembly();</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Build solver</span></div>
<div class="line">    log::cout() &lt;&lt; <span class="stringliteral">&quot;Building solver...&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">bool</span> multigrid = <span class="keyword">true</span>;</div>
<div class="line">    <span class="keywordtype">bool</span> <a class="code hl_function" href="namespacebitpit_1_1log.html#a9bf940a037d10e3bfc44e8ea5a2b4623">debug</a>     = <span class="keyword">false</span>;</div>
<div class="line">    <span class="keywordtype">bool</span> <a class="code hl_function" href="group__lamanipulation.html#ga0e9a3490052e83f4217825253f58797e">transpose</a> = <span class="keyword">false</span>;</div>
<div class="line">    <a class="code hl_class" href="classAMGSystemSolver.html">AMGSystemSolver</a> solver(transpose, multigrid, debug);</div>
<div class="line"> </div>
<div class="line">    solver.assembly(matrix);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">double</span> *rhs = solver.getRHSRawPtr();</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; blockSize * nCols; ++i) {</div>
<div class="line">        rhs[i] = 1.;</div>
<div class="line">    }</div>
<div class="line">    solver.restoreRHSRawPtr(rhs);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">double</span> *initialSolution = solver.getSolutionRawPtr();</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; nRows; ++i) {</div>
<div class="line">        initialSolution[i] = 0;</div>
<div class="line">    }</div>
<div class="line">    solver.restoreSolutionRawPtr(initialSolution);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Export system</span></div>
<div class="line">    solver.exportMatrix(<span class="stringliteral">&quot;LA_example_0001_matrix.txt&quot;</span>, SystemSolver::FILE_ASCII);</div>
<div class="line">    solver.exportRHS(<span class="stringliteral">&quot;LA_example_0001_rhs.txt&quot;</span>, SystemSolver::FILE_ASCII);</div>
<div class="line">    solver.exportSolution(<span class="stringliteral">&quot;LA_example_0001_solution.txt&quot;</span>, SystemSolver::FILE_ASCII);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Dump system</span></div>
<div class="line">    log::cout() &lt;&lt; <span class="stringliteral">&quot;Dumping initialized linear system...&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">    solver.dumpSystem(<span class="stringliteral">&quot;bitpit linear system&quot;</span>, <span class="stringliteral">&quot;.&quot;</span>, <span class="stringliteral">&quot;LA_example_0001_linear_system_&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Set KSP</span></div>
<div class="line">    <a class="code hl_struct" href="structbitpit_1_1KSPOptions.html">KSPOptions</a> &amp;options = solver.getKSPOptions();</div>
<div class="line">    options.<a id="a8" name="a8"></a><a class="code hl_variable" href="structbitpit_1_1KSPOptions.html#a9fcbc4756df506dfda4df81fef7ed538">atol</a>             = 1e-50;</div>
<div class="line">    options.<a id="a9" name="a9"></a><a class="code hl_variable" href="structbitpit_1_1KSPOptions.html#aba52d9ed1fed9c9e84881206c8618f11">rtol</a>             = 1e-7;</div>
<div class="line">    options.<a id="a10" name="a10"></a><a class="code hl_variable" href="structbitpit_1_1KSPOptions.html#a435b4313a0753eaeacb3e059f517eb93">maxits</a>           = 100;</div>
<div class="line">    options.<a id="a11" name="a11"></a><a class="code hl_variable" href="structbitpit_1_1KSPOptions.html#ad503641d3de01be4c06ff58e2bbaa674">initial_non_zero</a> = PETSC_FALSE;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Solve System</span></div>
<div class="line">    log::cout() &lt;&lt; <span class="stringliteral">&quot;Solve linear system...&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">    solver.solve();</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <a id="_a12" name="_a12"></a><a class="code hl_struct" href="structbitpit_1_1KSPStatus.html">KSPStatus</a> &amp;status = solver.getKSPStatus();</div>
<div class="line">    log::cout() &lt;&lt; <span class="stringliteral">&quot;Reason: &quot;</span> &lt;&lt; status.<a id="a13" name="a13"></a>convergence &lt;&lt; <span class="stringliteral">&quot; in its: &quot;</span> &lt;&lt; status.<a id="a14" name="a14"></a>its &lt;&lt; std::endl;</div>
<div class="line">    log::cout() &lt;&lt; <span class="stringliteral">&quot;Linear system solved.&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Export solution</span></div>
<div class="line">    log::cout() &lt;&lt; <span class="stringliteral">&quot;Export solution...&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">    solver.exportSolution(<span class="stringliteral">&quot;LA_example_0001_linear_system_solution.dat&quot;</span>, bitpit::SystemSolver::FILE_BINARY);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Compare computed solution with expected one</span></div>
<div class="line">    <span class="comment">//</span></div>
<div class="line">    <span class="comment">// Set comparison tolerance to the linear system relative tolerance</span></div>
<div class="line">    log::cout() &lt;&lt; <span class="stringliteral">&quot;Comparing solutions...&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> TOLERANCE = options.<a class="code hl_variable" href="structbitpit_1_1KSPOptions.html#aba52d9ed1fed9c9e84881206c8618f11">rtol</a>;</div>
<div class="line">    log::cout() &lt;&lt; <span class="stringliteral">&quot;    Tolerance = &quot;</span> &lt;&lt; options.<a class="code hl_variable" href="structbitpit_1_1KSPOptions.html#aba52d9ed1fed9c9e84881206c8618f11">rtol</a> &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">    std::size_t nRowElements = solver.getRowElementCount();</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">bool</span> isSolutionCorrect = <span class="keyword">true</span>;</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> *solution = solver.getSolutionRawReadPtr();</div>
<div class="line">    <span class="keywordflow">for</span> (std::size_t i = 0; i &lt; nRowElements; ++i) {</div>
<div class="line">        std::size_t globalDOF = rowOffset * blockSize + i;</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Check for absolute tolerance only</span></div>
<div class="line">        <span class="keywordtype">double</span> expectedSolution = <span class="keyword">static_cast&lt;</span><span class="keywordtype">double</span><span class="keyword">&gt;</span>(globalDOF + 1);</div>
<div class="line">        <span class="keywordflow">if</span> (!<a id="_a15" name="_a15"></a><a class="code hl_struct" href="structbitpit_1_1utils_1_1DoubleFloatingEqual.html">utils::DoubleFloatingEqual</a>()(expectedSolution - solution[i], 0.0, TOLERANCE, TOLERANCE)) {</div>
<div class="line">            std::stringstream message;</div>
<div class="line">            message &lt;&lt; <span class="stringliteral">&quot;Solutions do not match for global DOF #&quot;</span> &lt;&lt; globalDOF &lt;&lt; <span class="stringliteral">&quot;.&quot;</span>;</div>
<div class="line">            message &lt;&lt; <span class="stringliteral">&quot; Expected solution is &quot;</span> &lt;&lt; expectedSolution;</div>
<div class="line">            message &lt;&lt; <span class="stringliteral">&quot;, current solution is &quot;</span> &lt;&lt; solution[i] &lt;&lt; <span class="stringliteral">&quot;.&quot;</span>;</div>
<div class="line">            log::cout() &lt;&lt; message.str() &lt;&lt; std::endl;</div>
<div class="line">            isSolutionCorrect = <span class="keyword">false</span>;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    solver.restoreSolutionRawReadPtr(solution);</div>
<div class="line">    <span class="keywordflow">if</span> (isSolutionCorrect) {</div>
<div class="line">        log::cout() &lt;&lt; <span class="stringliteral">&quot;Solutions match.&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> run_restore(<span class="keywordtype">int</span> rank, <span class="keywordtype">int</span> nProcs)</div>
<div class="line">{</div>
<div class="line">    <a id="a16" name="a16"></a><a class="code hl_define" href="group__common__macro.html#gacb5eef7cdb2adda3b65bfe01c66667a4">BITPIT_UNUSED</a>(rank);</div>
<div class="line">    <a class="code hl_define" href="group__common__macro.html#gacb5eef7cdb2adda3b65bfe01c66667a4">BITPIT_UNUSED</a>(nProcs);</div>
<div class="line"> </div>
<div class="line">    log::cout() &lt;&lt; std::endl;</div>
<div class="line">    log::cout() &lt;&lt; <span class="stringliteral">&quot;Running restore example...&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Restore solver with initial guess</span></div>
<div class="line">    log::cout() &lt;&lt; <span class="stringliteral">&quot;Restoring linear system ...&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">    <span class="keywordtype">bool</span> multigrid = <span class="keyword">true</span>;</div>
<div class="line">    <span class="keywordtype">bool</span> <a class="code hl_function" href="namespacebitpit_1_1log.html#a9bf940a037d10e3bfc44e8ea5a2b4623">debug</a>     = <span class="keyword">false</span>;</div>
<div class="line">    <span class="keywordtype">bool</span> <a class="code hl_function" href="group__lamanipulation.html#ga0e9a3490052e83f4217825253f58797e">transpose</a> = <span class="keyword">false</span>;</div>
<div class="line">    <a class="code hl_class" href="classAMGSystemSolver.html">AMGSystemSolver</a> solver(transpose, multigrid, debug);</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#if BITPIT_ENABLE_MPI==1</span></div>
<div class="line">    solver.restoreSystem(MPI_COMM_WORLD, <span class="keyword">false</span>, <span class="stringliteral">&quot;.&quot;</span>, <span class="stringliteral">&quot;LA_example_0001_linear_system_&quot;</span>);</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line">    solver.restoreSystem(<span class="stringliteral">&quot;.&quot;</span>, <span class="stringliteral">&quot;LA_example_0001_linear_system_&quot;</span>);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">    log::cout() &lt;&lt; <span class="stringliteral">&quot;Linear system restored.&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Export system</span></div>
<div class="line">    solver.exportMatrix(<span class="stringliteral">&quot;LA_example_0001_restored_matrix.txt&quot;</span>, SystemSolver::FILE_ASCII);</div>
<div class="line">    solver.exportRHS(<span class="stringliteral">&quot;LA_example_0001_restored_rhs.txt&quot;</span>, SystemSolver::FILE_ASCII);</div>
<div class="line">    solver.exportSolution(<span class="stringliteral">&quot;LA_example_0001_restored_solution.txt&quot;</span>, SystemSolver::FILE_ASCII);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Set KSP options</span></div>
<div class="line">    <a class="code hl_struct" href="structbitpit_1_1KSPOptions.html">KSPOptions</a> &amp;options = solver.getKSPOptions();</div>
<div class="line">    options.<a class="code hl_variable" href="structbitpit_1_1KSPOptions.html#a9fcbc4756df506dfda4df81fef7ed538">atol</a>             = 1e-50;</div>
<div class="line">    options.<a class="code hl_variable" href="structbitpit_1_1KSPOptions.html#aba52d9ed1fed9c9e84881206c8618f11">rtol</a>             = 1e-7;</div>
<div class="line">    options.<a class="code hl_variable" href="structbitpit_1_1KSPOptions.html#a435b4313a0753eaeacb3e059f517eb93">maxits</a>           = 100;</div>
<div class="line">    options.<a class="code hl_variable" href="structbitpit_1_1KSPOptions.html#ad503641d3de01be4c06ff58e2bbaa674">initial_non_zero</a> = PETSC_FALSE;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Solve linear system</span></div>
<div class="line">    log::cout() &lt;&lt; <span class="stringliteral">&quot;Solving linear system...&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">    solver.solve();</div>
<div class="line"> </div>
<div class="line">    <span class="keyword">const</span> <a class="code hl_struct" href="structbitpit_1_1KSPStatus.html">KSPStatus</a> &amp;status = solver.getKSPStatus();</div>
<div class="line">    log::cout() &lt;&lt; <span class="stringliteral">&quot;Reason: &quot;</span> &lt;&lt; status.convergence &lt;&lt; <span class="stringliteral">&quot; in its: &quot;</span> &lt;&lt; status.its &lt;&lt; std::endl;</div>
<div class="line">    log::cout() &lt;&lt; <span class="stringliteral">&quot;Linear system solved.&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Turn solution comparison on</span></div>
<div class="line">    <span class="keywordtype">bool</span> compareSolutions = <span class="keyword">true</span>;</div>
<div class="line">    <span class="keywordflow">if</span> (compareSolutions) {</div>
<div class="line">        <span class="comment">// Store expected solution for comparison</span></div>
<div class="line">        log::cout() &lt;&lt; <span class="stringliteral">&quot;Storing computed solution for comparison...&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">        std::size_t nRowElements = solver.getRowElementCount();</div>
<div class="line">        std::vector&lt;double&gt; expectedSolution(nRowElements, 0.0);</div>
<div class="line">        <span class="keywordtype">double</span> *computedSolution = solver.getSolutionRawPtr();</div>
<div class="line">        <span class="keywordflow">for</span> (std::size_t i = 0; i &lt; nRowElements; ++i) {</div>
<div class="line">            expectedSolution[i] = computedSolution[i];</div>
<div class="line">        }</div>
<div class="line">        solver.restoreSolutionRawPtr(computedSolution);</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Import solution with solution from outside</span></div>
<div class="line">        log::cout() &lt;&lt; <span class="stringliteral">&quot;Restoring solution...&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">        solver.importSolution(<span class="stringliteral">&quot;LA_example_0001_linear_system_solution.dat&quot;</span>);</div>
<div class="line">        log::cout() &lt;&lt; <span class="stringliteral">&quot;Solution restored.&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Compare computed solution with restored one</span></div>
<div class="line">        <span class="comment">//</span></div>
<div class="line">        <span class="comment">// Set comparison tolerance to the linear system relative tolerance</span></div>
<div class="line">        log::cout() &lt;&lt; <span class="stringliteral">&quot;Comparing solutions...&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">double</span> TOLERANCE = options.<a class="code hl_variable" href="structbitpit_1_1KSPOptions.html#aba52d9ed1fed9c9e84881206c8618f11">rtol</a>;</div>
<div class="line">        log::cout() &lt;&lt; <span class="stringliteral">&quot;    Tolerance = &quot;</span> &lt;&lt; options.<a class="code hl_variable" href="structbitpit_1_1KSPOptions.html#aba52d9ed1fed9c9e84881206c8618f11">rtol</a> &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordtype">bool</span> isSolutionCorrect = <span class="keyword">true</span>;</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">double</span> *solution = solver.getSolutionRawReadPtr();</div>
<div class="line">        <span class="keywordflow">for</span> (std::size_t i = 0; i &lt; nRowElements; ++i) {</div>
<div class="line">            <span class="keywordflow">if</span> (!<a class="code hl_struct" href="structbitpit_1_1utils_1_1DoubleFloatingEqual.html">utils::DoubleFloatingEqual</a>()(expectedSolution[i] - solution[i], 0.0, TOLERANCE, TOLERANCE)) {</div>
<div class="line">                std::stringstream message;</div>
<div class="line">                message &lt;&lt; <span class="stringliteral">&quot;Solutions do not match for local DOF #&quot;</span> &lt;&lt; i &lt;&lt; <span class="stringliteral">&quot;.&quot;</span>;</div>
<div class="line">                message &lt;&lt; <span class="stringliteral">&quot; Expected solution is &quot;</span> &lt;&lt; expectedSolution[i];</div>
<div class="line">                message &lt;&lt; <span class="stringliteral">&quot;, current solution is &quot;</span> &lt;&lt; solution[i] &lt;&lt; <span class="stringliteral">&quot;.&quot;</span>;</div>
<div class="line">                log::cout() &lt;&lt; message.str() &lt;&lt; std::endl;</div>
<div class="line">                isSolutionCorrect = <span class="keyword">false</span>;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">        solver.restoreSolutionRawReadPtr(solution);</div>
<div class="line">        <span class="keywordflow">if</span> (isSolutionCorrect) {</div>
<div class="line">            log::cout() &lt;&lt; <span class="stringliteral">&quot;Solutions match.&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])</div>
<div class="line">{</div>
<div class="line"><span class="preprocessor">#if BITPIT_ENABLE_MPI==1</span></div>
<div class="line">    MPI_Init(&amp;argc, &amp;argv);</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line">    <a class="code hl_define" href="group__common__macro.html#gacb5eef7cdb2adda3b65bfe01c66667a4">BITPIT_UNUSED</a>(argc);</div>
<div class="line">    <a class="code hl_define" href="group__common__macro.html#gacb5eef7cdb2adda3b65bfe01c66667a4">BITPIT_UNUSED</a>(argv);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Initialize the logger</span></div>
<div class="line">    <span class="keywordtype">int</span> nProcs;</div>
<div class="line">    <span class="keywordtype">int</span> rank;</div>
<div class="line"><span class="preprocessor">#if BITPIT_ENABLE_MPI==1</span></div>
<div class="line">    MPI_Comm_size(MPI_COMM_WORLD, &amp;nProcs);</div>
<div class="line">    MPI_Comm_rank(MPI_COMM_WORLD, &amp;rank);</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line">    rank = 0;</div>
<div class="line">    nProcs = 1;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">    log::manager().initialize(log::COMBINED, <span class="keyword">true</span>, nProcs, rank);</div>
<div class="line">    log::cout().setDefaultVisibility(log::GLOBAL);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Run the subtests</span></div>
<div class="line">    log::cout() &lt;&lt; <span class="stringliteral">&quot;Build, dump, solve and restore linear system&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">int</span> status;</div>
<div class="line">    <span class="keywordflow">try</span> {</div>
<div class="line">        status = run_dump(rank, nProcs);</div>
<div class="line">        <span class="keywordflow">if</span> (status != 0) {</div>
<div class="line">            <span class="keywordflow">return</span> status;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        status = run_restore(rank, nProcs);</div>
<div class="line">        <span class="keywordflow">if</span> (status != 0) {</div>
<div class="line">            <span class="keywordflow">return</span> status;</div>
<div class="line">        }</div>
<div class="line">    } <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::exception &amp;exception) {</div>
<div class="line">        log::cout() &lt;&lt; exception.what();</div>
<div class="line">        exit(1);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#if BITPIT_ENABLE_MPI==1</span></div>
<div class="line">    MPI_Finalize();</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">}</div>
<div class="ttc" id="aclassAMGSystemSolver_html"><div class="ttname"><a href="classAMGSystemSolver.html">AMGSystemSolver</a></div><div class="ttdoc">The class AMGSystemSolver is derived form SystemSolver and it allows to solve the linear system using...</div><div class="ttdef"><b>Definition</b> <a href="LA__example__00001_8cpp_source.html#l00073">LA_example_00001.cpp:73</a></div></div>
<div class="ttc" id="aclassAMGSystemSolver_html_a5b9144e3e5eb76216e3ecbe73d0e2072"><div class="ttname"><a href="classAMGSystemSolver.html#a5b9144e3e5eb76216e3ecbe73d0e2072">AMGSystemSolver::AMGSystemSolver</a></div><div class="ttdeci">AMGSystemSolver(bool transpose, bool multigrid, bool debug)</div><div class="ttdef"><b>Definition</b> <a href="LA__example__00001_8cpp_source.html#l00083">LA_example_00001.cpp:83</a></div></div>
<div class="ttc" id="aclassbitpit_1_1SparseMatrix_html"><div class="ttname"><a href="classbitpit_1_1SparseMatrix.html">bitpit::SparseMatrix</a></div><div class="ttdoc">Sparse matrix.</div><div class="ttdef"><b>Definition</b> <a href="system__matrix_8hpp_source.html#l00038">system_matrix.hpp:38</a></div></div>
<div class="ttc" id="aclassbitpit_1_1SystemSolver_html"><div class="ttname"><a href="classbitpit_1_1SystemSolver.html">bitpit::SystemSolver</a></div><div class="ttdoc">The SystemSolver class provides methods for building and solving large linear systems.</div><div class="ttdef"><b>Definition</b> <a href="system__solvers__large_8hpp_source.html#l00264">system_solvers_large.hpp:264</a></div></div>
<div class="ttc" id="aclassbitpit_1_1SystemSolver_html_a0da428e8ea241f0d53ae8ee0e8ec19c3"><div class="ttname"><a href="classbitpit_1_1SystemSolver.html#a0da428e8ea241f0d53ae8ee0e8ec19c3">bitpit::SystemSolver::isPartitioned</a></div><div class="ttdeci">bool isPartitioned() const</div><div class="ttdef"><b>Definition</b> <a href="system__solvers__large_8cpp_source.html#l01210">system_solvers_large.cpp:1210</a></div></div>
<div class="ttc" id="aclassbitpit_1_1SystemSolver_html_aca37164c4ecb430a9e36b5723186e95f"><div class="ttname"><a href="classbitpit_1_1SystemSolver.html#aca37164c4ecb430a9e36b5723186e95f">bitpit::SystemSolver::SystemSolver</a></div><div class="ttdeci">SystemSolver(bool debug=false)</div><div class="ttdef"><b>Definition</b> <a href="system__solvers__large_8cpp_source.html#l00770">system_solvers_large.cpp:770</a></div></div>
<div class="ttc" id="aclassbitpit_1_1SystemSolver_html_ae9c0399c50d31d23c0f49e75d5a95434"><div class="ttname"><a href="classbitpit_1_1SystemSolver.html#ae9c0399c50d31d23c0f49e75d5a95434">bitpit::SystemSolver::setupPreconditioner</a></div><div class="ttdeci">virtual void setupPreconditioner()</div><div class="ttdef"><b>Definition</b> <a href="system__solvers__large_8cpp_source.html#l03267">system_solvers_large.cpp:3267</a></div></div>
<div class="ttc" id="agroup__common__macro_html_gacb5eef7cdb2adda3b65bfe01c66667a4"><div class="ttname"><a href="group__common__macro.html#gacb5eef7cdb2adda3b65bfe01c66667a4">BITPIT_UNUSED</a></div><div class="ttdeci">#define BITPIT_UNUSED(variable)</div><div class="ttdef"><b>Definition</b> <a href="compiler_8hpp_source.html#l00063">compiler.hpp:63</a></div></div>
<div class="ttc" id="agroup__lamanipulation_html_ga0e9a3490052e83f4217825253f58797e"><div class="ttname"><a href="group__lamanipulation.html#ga0e9a3490052e83f4217825253f58797e">bitpit::linearalgebra::transpose</a></div><div class="ttdeci">void transpose(std::vector&lt; std::vector&lt; T &gt; &gt; &amp;, std::vector&lt; std::vector&lt; T &gt; &gt; &amp;)</div><div class="ttdef"><b>Definition</b> <a href="manipulation_8tpp_source.html#l00041">manipulation.tpp:41</a></div></div>
<div class="ttc" id="anamespacebitpit_1_1log_html_a9bf940a037d10e3bfc44e8ea5a2b4623"><div class="ttname"><a href="namespacebitpit_1_1log.html#a9bf940a037d10e3bfc44e8ea5a2b4623">bitpit::log::debug</a></div><div class="ttdeci">Logger &amp; debug(log::Visibility defaultVisibility)</div><div class="ttdef"><b>Definition</b> <a href="logger_8cpp_source.html#l01882">logger.cpp:1882</a></div></div>
<div class="ttc" id="astructbitpit_1_1KSPOptions_html"><div class="ttname"><a href="structbitpit_1_1KSPOptions.html">bitpit::KSPOptions</a></div><div class="ttdef"><b>Definition</b> <a href="system__solvers__large_8hpp_source.html#l00040">system_solvers_large.hpp:40</a></div></div>
<div class="ttc" id="astructbitpit_1_1KSPOptions_html_a435b4313a0753eaeacb3e059f517eb93"><div class="ttname"><a href="structbitpit_1_1KSPOptions.html#a435b4313a0753eaeacb3e059f517eb93">bitpit::KSPOptions::maxits</a></div><div class="ttdeci">PetscInt maxits</div><div class="ttdoc">Number of iterations at which the GMRES method restarts.</div><div class="ttdef"><b>Definition</b> <a href="system__solvers__large_8hpp_source.html#l00046">system_solvers_large.hpp:46</a></div></div>
<div class="ttc" id="astructbitpit_1_1KSPOptions_html_a9fcbc4756df506dfda4df81fef7ed538"><div class="ttname"><a href="structbitpit_1_1KSPOptions.html#a9fcbc4756df506dfda4df81fef7ed538">bitpit::KSPOptions::atol</a></div><div class="ttdeci">PetscScalar atol</div><div class="ttdoc">Relative convergence tolerance, relative decrease in the preconditioned residual norm.</div><div class="ttdef"><b>Definition</b> <a href="system__solvers__large_8hpp_source.html#l00048">system_solvers_large.hpp:48</a></div></div>
<div class="ttc" id="astructbitpit_1_1KSPOptions_html_aba52d9ed1fed9c9e84881206c8618f11"><div class="ttname"><a href="structbitpit_1_1KSPOptions.html#aba52d9ed1fed9c9e84881206c8618f11">bitpit::KSPOptions::rtol</a></div><div class="ttdeci">PetscScalar rtol</div><div class="ttdoc">Maximum number of iterations.</div><div class="ttdef"><b>Definition</b> <a href="system__solvers__large_8hpp_source.html#l00047">system_solvers_large.hpp:47</a></div></div>
<div class="ttc" id="astructbitpit_1_1KSPOptions_html_ad503641d3de01be4c06ff58e2bbaa674"><div class="ttname"><a href="structbitpit_1_1KSPOptions.html#ad503641d3de01be4c06ff58e2bbaa674">bitpit::KSPOptions::initial_non_zero</a></div><div class="ttdeci">PetscBool initial_non_zero</div><div class="ttdoc">Number of levels of fill used by the preconditioner.</div><div class="ttdef"><b>Definition</b> <a href="system__solvers__large_8hpp_source.html#l00044">system_solvers_large.hpp:44</a></div></div>
<div class="ttc" id="astructbitpit_1_1KSPStatus_html"><div class="ttname"><a href="structbitpit_1_1KSPStatus.html">bitpit::KSPStatus</a></div><div class="ttdef"><b>Definition</b> <a href="system__solvers__large_8hpp_source.html#l00062">system_solvers_large.hpp:62</a></div></div>
<div class="ttc" id="astructbitpit_1_1utils_1_1DoubleFloatingEqual_html"><div class="ttname"><a href="structbitpit_1_1utils_1_1DoubleFloatingEqual.html">bitpit::utils::DoubleFloatingEqual</a></div><div class="ttdef"><b>Definition</b> <a href="commonUtils_8hpp_source.html#l00160">commonUtils.hpp:161</a></div></div>
</div><!-- fragment --> </div><!-- contents -->
---
layout: doxygen_footer
---
{% endraw %}
<!-- HTML footer for doxygen 1.8.9.1-->
<!-- start footer part -->
<address class="footer"><small>
Generated on Wed Jun 19 2024 10:21:04 for bitpit by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.10.0
</small></address>
